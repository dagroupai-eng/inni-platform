# 도시공간데이터 Shapefile 통합 기능 안내

## 📌 개요

도시공간데이터포털의 Shapefile 데이터를 Urban ArchInsight에 통합하는 기능을 추가했습니다. 이제 실제 행정구역, 토지소유정보, 개별공시지가 등 공간데이터를 지도에서 확인하고 분석할 수 있습니다.

## 🎯 추가된 기능

### 1. Shapefile 업로드 및 로드
- **ZIP 파일 지원**: 도시공간데이터포털에서 다운로드한 ZIP 파일 직접 업로드
- **자동 좌표계 변환**: GRS80, Bessel 등 한국 좌표계를 자동으로 WGS84로 변환
- **인코딩 자동 처리**: CP949, EUC-KR 등 한글 인코딩 자동 감지 및 처리

### 2. 데이터 검증
- **Geometry 검증**: 유효하지 않은 지형 데이터 자동 감지
- **중복 데이터 확인**: 중복된 geometry 감지
- **좌표계 정보 확인**: 누락된 좌표계 정보 경고

### 3. 지도 시각화
- **Streamlit 지도 통합**: 업로드한 Shapefile을 st.map()으로 바로 시각화
- **레이어 정보 표시**: 피처 수, 좌표계, 컬럼 정보 등 상세 정보 제공
- **데이터 미리보기**: 원본 데이터를 테이블 형태로 확인

## 📂 파일 구조

### 새로 추가된 파일

```
geo_data_loader.py          # 지오데이터 로더 모듈
├── GeoDataLoader 클래스      # Shapefile 로드 및 처리
├── validate_shapefile_data  # 데이터 검증 함수
└── LAYER_TYPE_MAPPING      # 레이어 타입 매핑
```

### 수정된 파일

```
pages/3_🗺️_Mapping.py       # Mapping 페이지 확장
├── 탭 구조 개선            # 샘플 데이터 / Shapefile 업로드 분리
├── Shapefile 업로드 UI     # 파일 업로드 및 처리 인터페이스
└── 시각화 개선             # 업로드 데이터 지도 표시
```

## 🚀 사용 방법

### 1. 도시공간데이터 다운로드

1. **도시공간데이터포털** 접속: https://www.citydata.go.kr
2. **원하는 데이터셋 검색**:
   - 행정구역_읍면동(법정동)
   - (센서스경계)시군구경계
   - 토지소유정보
   - 개별공시지가정보
   - 도로명주소 건물
   - 국토계획/공간시설
3. **ZIP 파일 다운로드**

### 2. Urban ArchInsight에서 업로드

1. **Mapping 페이지**로 이동
2. **"Shapefile 업로드"** 탭 선택
3. **ZIP 파일 업로드**
4. **자동 로드 및 검증** 확인
5. **지도에서 시각화** 확인

### 3. 데이터 확인

- **레이어 정보**: 피처 수, 좌표계, 컬럼 정보
- **지형 유형**: Polygon, Point, Line 등
- **경계 좌표**: 최서단, 최남단, 최동단, 최북단
- **원본 데이터**: 데이터프레임 미리보기

## 📊 지원하는 데이터 형식

### 주요 데이터셋

| 데이터셋 | 파일명 예시 | 용도 |
|---------|------------|------|
| 행정구역 | LSMD_ADM_SECT_UMD_*.zip | 시군구, 읍면동 경계 |
| 시군구경계 | SHP_BND_SIGUNGU_PG.zip | 센서스 경계 |
| 토지소유정보 | AL_D160_*.zip | 토지 소유자 정보 |
| 개별공시지가 | C_UQ161.zip | 공시지가 데이터 |
| 도로명주소 건물 | BULD_*.zip | 건물 위치 및 주소 |
| 국토계획 시설 | TLS_SPNT_AREA.zip | 도시계획 시설 |

### 좌표계 지원

- **GRS80** (EPSG:5186) - 가장 일반적
- **WGS84** (EPSG:4326) - 위경도, 지도 표시용
- **Bessel** (EPSG:5174) - 베셀 타원체
- **KATEC** (EPSG:5179) - 변형 투영

### 인코딩 지원

- **CP949** (WINDOWS-949) - Windows 한국어
- **EUC-KR** - 확장 유닉스 코드

## 🔧 기술 구현 세부사항

### 1. GeoDataLoader 클래스

```python
class GeoDataLoader:
    """도시공간데이터 Shapefile을 로드하고 처리하는 클래스"""
    
    def load_shapefile_from_zip(self, zip_file_data, encoding='cp949'):
        """ZIP 파일에서 Shapefile 로드"""
        # 메모리에서 ZIP 압축 해제
        # 임시 디렉토리에 파일 추출
        # GeoDataFrame 로드
        # 좌표계 자동 변환
        
    def _transform_crs(self, gdf, target_crs='EPSG:4326'):
        """좌표계 변환 (WGS84로 통일)"""
        
    def gdf_to_dataframe_for_map(self, gdf):
        """GeoDataFrame을 Streamlit 지도용 DataFrame으로 변환"""
```

### 2. 데이터 검증

```python
def validate_shapefile_data(gdf):
    """Shapefile 데이터 유효성 검증"""
    # 빈 데이터 확인
    # 좌표계 정보 확인
    # 유효하지 않은 geometry 확인
    # 중복 geometry 확인
```

### 3. 좌표계 변환

- **입력 좌표계 자동 감지**: GeoPandas의 CRS 정보 활용
- **WGS84로 자동 변환**: Streamlit st.map() 호환성
- **오류 처리**: 변환 실패 시 원본 유지

## 💡 활용 예시

### 예시 1: 행정구역 경계 확인

```
1. 도시공간데이터포털에서 "행정구역_읍면동" 검색
2. 서울 지역 ZIP 파일 다운로드
3. Urban ArchInsight에 업로드
4. 지도에서 읍면동 경계 확인
```

### 예시 2: 토지소유정보 분석

```
1. "토지소유정보" 데이터셋 다운로드
2. 업로드 및 로드
3. 레이어 정보에서 속성 컬럼 확인
4. 원본 데이터 미리보기로 소유자 정보 확인
```

### 예시 3: 개별공시지가 검토

```
1. "개별공시지가정보" 다운로드
2. 업로드 후 경계 좌표 확인
3. 지도에서 공시지가 분포 파악
4. 데이터프레임으로 상세 정보 확인
```

## ⚠️ 주의사항

### 파일 크기 제한

- Streamlit 기본 파일 업로드 제한: **200MB**
- 대용량 데이터는 지역별로 나누어 업로드 권장

### 좌표계 주의

- **자동 변환**: 모든 한국 좌표계는 WGS84로 자동 변환
- **정밀도**: 변환 과정에서 미세한 좌표 오차 발생 가능

### 인코딩 문제

- **기본값**: CP949 (WINDOWS-949) 사용
- **오류 발생 시**: 다른 인코딩(EUC-KR 등) 시도

## 🔮 향후 확장 가능성

### 단기 개선
- [ ] 데이터 속성 필터링 기능
- [ ] 여러 레이어 동시 표시 (레이어 조합)
- [ ] 속성 데이터 시각화 (컬러맵)
- [ ] 선택 영역 분석 기능

### 중기 개선
- [ ] GIS 분석 도구 (교차 분석, 버퍼 분석 등)
- [ ] CSV로 export 기능
- [ ] 캐싱 기능 (이미 업로드한 데이터 재사용)
- [ ] 저장소 연동 (클라우드 스토리지)

### 장기 개선
- [ ] 실시간 업데이트 데이터 연동
- [ ] 3D 시각화 (Plotly 3D)
- [ ] 공간 분석 AI 블록 통합
- [ ] 분광 분석 기능

## 📚 참고 자료

- **도시공간데이터포털**: https://www.citydata.go.kr
- **GeoPandas 문서**: https://geopandas.org/
- **EPSG 좌표계 정보**: https://epsg.io/
- **Shapefile 포맷**: https://en.wikipedia.org/wiki/Shapefile

## 🙋 문의 및 지원

기능 관련 문의나 버그 신고는 GitHub Issues에 등록해주세요.

---

**작성일**: 2025-01-XX  
**버전**: 1.0.0  
**상태**: Stable

