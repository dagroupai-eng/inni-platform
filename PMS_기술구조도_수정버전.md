# PMS 기술 구조도 (수정 반영 버전)
## Urban ArchInsight - 교육용 도시 프로젝트 분석 플랫폼

> **설계 원칙**: 실제 프로젝트 진행 순서에 맞춘 페이지 구성, 페이지 단위로 즉시 실행
>
> **수정 일자**: 2025-01-20
>
> **주요 변경사항**:
> - 페이지 순서 재구성 (실제 작업 흐름 반영)
> - Site Data Collection 제거 → Mapping에 통합
> - 모든 기능에 확인 버튼 추가
> - 페이지 간 데이터 영속성 강화
> - 25명 동시 접속 지원 (4~5인 5개팀)

---

## 📋 시스템 개요

### 페이지 구조 (실제 작업 순서)

```
🏠 메인 페이지 (app.py)
    ↓
1️⃣ Block Generator (분석 블록 생성/수정)
    ↓
2️⃣ Mapping (지도 분석 및 데이터 수집)
    ↓
3️⃣ Document Analysis (문서 분석 실행)
    ↓
4️⃣ Prompt Generator (이미지 프롬프트 생성)
    ↓
5️⃣ Video Storyboard Generator (영상 스토리보드 생성) [신규]
```

---

## 🏠 메인 페이지 (app.py)

**목적**: AI 모델 선택, API 키 관리, 시스템 안내

### 핵심 기능

1. **AI 모델 선택 및 관리**
   - 지원 모델: Gemini 2.5 Pro, Gemini 3 pro, Gemini 2.5 Flash, Gemini 3.0 Flash
   - 드롭다운으로 모델 선택
   - 모델별 파라미터 표시

2. **API 키 관리 (개선)**
   - API 키 입력 필드 (비밀번호 형식)
   - ✅ **확인 버튼**: 키 저장 및 검증
   - 🗑️ **삭제 버튼**: 키 제거
   - 키 상태 표시 (설정됨/미설정, 출처 표시)
   - 키 길이 및 유효성 확인

3. **시스템 상태 대시보드**
   - 필수 모듈 설치 상태
   - API 키 설정 상태
   - 동시 접속자 수 표시 (최대 25명)
   - 시스템 리소스 사용률 (메모리, CPU)

4. **빠른 시작 가이드**
   - 단계별 튜토리얼
   - 각 페이지 기능 소개
   - 샘플 프로젝트 로드 버튼

5. **세션 관리**
   - 개인 세션 ID 자동 생성
   - 세션별 데이터 격리
   - 세션 저장/불러오기 기능
   - 세션 만료 시간 설정 (기본 4시간)

6. **에러 처리 및 복구**
   - 자동 오류 감지
   - 오류 복구 안내
   - 로그 다운로드 기능

---

## 1️⃣ Block Generator (분석 블록 생성기)

**목적**: 커스텀 분석 블록 생성, 수정, 관리

### 페이지 레이아웃

```
[사이드바]                    [메인 컨텐츠]
- 기존 블록 목록               - 블록 정보 입력 폼
- 카테고리별 필터              - RISEN 프롬프트 구조
- 내 블록 / 공용 블록          - 미리보기
- 검색                        - 생성/수정/삭제 버튼
```

### 핵심 기능

#### 1. **기본 정보 입력 (개선)**
   - 블록 이름 (text_input)
   - 블록 설명 (text_area)
   - 카테고리 선택 (selectbox)
     - 기본 정보 & 요구사항
     - 입지 분석
     - 프로그램 계획
     - 공간 계획
     - 비즈니스 모델 [신규]
     - 기타 (새 카테고리 추가)
   - **개인 번호 부여 (신규)**:
     - 자동 생성: `{세션ID}_{카테고리}_{번호}`
     - 예시: `USER001_입지분석_001`
   - 공개 범위 선택: 개인용 / 팀 공유 / 전체 공개

#### 2. **RISEN 프롬프트 구조 (개선)**
   - **역할 (Role)**: AI 전문가 역할 정의
   - **지시 (Instructions)**: 구체적 작업 지시
   - **단계 (Steps)**:
     - 단계 개수 선택 (1~10)
     - **✅ 확인 버튼**: 단계 개수 확정 후 입력 필드 생성
     - 각 단계별 상세 내용 입력
   - **최종 목표 (End Goal)**: 달성 결과
   - **구체화/제약 조건 (Narrowing)**:
     - 출력 형식, 필수 항목, 제약 조건
     - 품질 기준, 평가 기준, 점수 체계

#### 3. **블록 생성 및 관리 (개선)**
   - **📝 블록 생성**: 새 블록 생성 및 저장
   - **💾 블록 저장**: 수정 내용 저장
   - **👁️ 블록 상세 보기**: 선택한 블록의 전체 정보 표시
   - **✏️ 블록 수정**: 기존 블록 편집
   - **🗑️ 블록 삭제**: 블록 제거 (확인 다이얼로그)
   - **📋 블록 복제**: 기존 블록 복사 후 수정
   - **⬇️ 블록 내보내기**: JSON 파일로 다운로드
   - **⬆️ 블록 가져오기**: JSON 파일에서 블록 로드

#### 4. **카테고리별 템플릿 블록 (신규)**
   - 각 카테고리당 1개의 템플릿 블록 제공
   - **기본 정보 & 요구사항**: "요구사항 파싱 템플릿"
   - **입지 분석**: "후보지 평가 템플릿"
   - **프로그램 계획**: "프로그램 구성 템플릿"
   - **공간 계획**: "공간 배치 템플릿"
   - **비즈니스 모델**: "비즈니스 모델 캔버스 템플릿"
   - 템플릿 기반 빠른 생성 가능

#### 5. **블록 관리 시스템 (신규)**
   - **내 블록**: 개인이 생성한 블록 목록
   - **팀 블록**: 팀원과 공유된 블록
   - **공용 블록**: 모두가 사용 가능한 블록
   - **즐겨찾기**: 자주 사용하는 블록 저장
   - **최근 사용**: 최근 사용한 블록 히스토리

#### 6. **블록 검색 및 필터링 (신규)**
   - 이름, 설명, 카테고리로 검색
   - 카테고리별 필터
   - 공개 범위별 필터
   - 최근 생성순/이름순 정렬

#### 7. **블록 미리보기 (신규)**
   - 실시간 프롬프트 미리보기
   - 예상 출력 형식 표시
   - DSPy Signature 코드 미리보기
   - JSON 구조 미리보기

#### 8. **블록 검증 (신규)**
   - 필수 필드 체크
   - 프롬프트 품질 점수
   - 중복 블록 확인
   - 저장 전 검증 실행

#### 9. **DSL 구조 설명 (신규)**
   - **블록 저장 구조 설명**:
     ```json
     {
       "block_id": "user001_location_001",
       "name": "후보지 평가",
       "category": "입지 분석",
       "owner": "USER001",
       "visibility": "private",
       "role": "...",
       "instructions": "...",
       "steps": [...],
       "end_goal": "...",
       "narrowing": {...}
     }
     ```
   - **분석 과정 설명**:
     1. 블록 로드 → DSPy Signature 생성
     2. AI 모델에 프롬프트 전달
     3. Chain-of-Thought 실행
     4. 결과 구조화 및 저장
   - **예시 블록 3개 제공**:
     - 기본 정보 추출 블록
     - 입지 분석 블록
     - 비즈니스 모델 블록

---

## 2️⃣ Mapping (지도 분석 및 데이터 수집)

**목적**: 공간 정보 시각화, 도시 데이터 수집, 분석 블록 연동

### 페이지 레이아웃

```
[탭 1: 연속 지적도]
[탭 2: 데이터 수집] [신규 - Site Data Collection 통합]
[탭 3: 입지 후보지 시각화]
```

### 탭 1: 연속 지적도 (기존 유지 + 개선)

#### 핵심 기능

1. **지도 위치 설정**
   - 위도/경도 입력
   - **✅ 확인 버튼**: 위치 이동 실행
   - 줌 레벨 선택 (5~19)
   - 주요 도시 선택 드롭다운
   - **📍 선택 도시로 이동 버튼**

2. **VWorld 레이어 선택 (확대)**
   - **연속 지적도**:
     - 본번 레이어
     - 부번 레이어
   - **용도지역** (8개 → 15개로 확대):
     - 도시지역, 관리지역, 농림지역, 자연환경보전지역
     - 경관지구, 미관지구, 고도지구 [신규]
     - 방재지구, 방화지구, 보존지구 [신규]
     - 시설보호지구, 취락지구 [신규]
     - 개발진흥지구, 특정용도제한지구 [신규]
     - 개발제한구역, 국토계획구역 [신규]
   - **도시계획시설** (7개 → 12개로 확대):
     - 도로, 교통시설, 공간시설, 공공문화체육시설
     - 방재시설, 환경기초시설, 지구단위계획
     - 학교시설 [신규]
     - 의료시설 [신규]
     - 유통공급시설 [신규]
     - 보건위생시설 [신규]
     - 문화시설 [신규]
   - **토지이용계획** [신규]:
     - 토지이용계획 확인서 레이어
     - 개발행위허가제한 레이어
   - 레이어 투명도 조절 슬라이더

3. **지적 정보 조회**
   - 지도 클릭 → 위치 자동 저장
   - **🔍 이 위치의 지적 정보 조회 버튼**
   - GetFeatureInfo 실행
   - 조회 결과 표시:
     - 필지 정보 (PNU, 지번, 지목, 면적)
     - 공시지가, 소유 구분
     - 주소 정보
   - **💾 정보 저장 버튼**: session_state에 저장

4. **WFS 고급 조회 (개선)**
   - BBOX 영역 설정
   - 조회 레이어 선택
   - 최대 피처 수 설정
   - **🔍 WFS 데이터 조회 버튼**
   - 결과 테이블 표시
   - **⬇️ GeoJSON 다운로드 버튼**
   - **💾 데이터 저장 버튼**: session_state에 저장

---

## 3️⃣ Document Analysis (문서 분석)

**목적**: 프로젝트 문서 분석 및 AI 기반 다단계 분석 실행

### 페이지 레이아웃

```
[탭 1: 프로젝트 정보]
[탭 2: 파일 업로드]
[탭 3: 분석 블록 선택]
[탭 4: 분석 실행]
[탭 5: 결과 조회]
```

### 핵심 기능

#### 1. **프로젝트 기본 정보 입력 (개선)**
   - 프로젝트명 입력
   - 위치 입력
   - 위도/경도 입력
   - 프로젝트 목표 (text_area)
   - 추가 정보 (text_area)
   - **Mapping 데이터 불러오기 버튼** [신규]:
     - session_state.mapping_data 로드
     - "반경 데이터" 섹션에 자동 입력
     - 데이터 미리보기 표시
   - **✅ 정보 저장 버튼**: session_state에 저장

#### 2. **파일 업로드 (개선)**
   - 파일 업로드 (PDF, DOCX, XLSX, CSV)
   - **✅ 파일 분석 버튼**: 텍스트 추출 실행
   - 파일 정보 표시 (크기, 페이지 수, 단어 수)
   - 파일 미리보기 (최대 500자)
   - **✅ 모든 파일 확인 버튼**: 최종 확인

#### 3. **분석 블록 선택 (개선)**
   - **블록 카테고리 필터**: 전체/입지/프로그램/공간/비즈니스
   - **내 블록 / 공용 블록 필터**
   - 블록 목록 (체크박스):
     - 블록 이름, 설명, 카테고리 표시
     - 블록 상세 보기 (Expander)
   - **블록 순서 조정**:
     - ⬆️ 위로 버튼
     - ⬇️ 아래로 버튼
   - **선택한 블록 요약**: 개수 및 순서 표시
   - **✅ 블록 선택 확정 버튼**

#### 4. **분석 실행 (개선) - 핵심 기능**

   **분석 전 설정**:
   - LLM 파라미터 설정:
     - Temperature (0.0 ~ 1.0)
     - Max Tokens (1000 ~ 32000)
   - **Chain-of-Thought 옵션**:
     - 단계별 사고 과정 표시
     - 중간 결과 저장
   - **✅ 설정 확인 버튼**

   **분석 세션 준비**:
   - **🚀 분석 시작 버튼**
   - 선택한 블록 순서 확인
   - 예상 소요 시간 표시
   - 확인 다이얼로그

   **분석 진행 중 제어 (신규)**:
   - **진행 상황 표시**:
     - 전체 진행률 (Progress bar)
     - 현재 실행 중인 블록 표시
     - 완료된 블록 / 전체 블록
   - **⏸️ 일시 정지 버튼** [신규]:
     - 분석 일시 중지
     - 현재까지의 결과 저장
     - 재개 가능
   - **⏭️ 블록 건너뛰기 버튼** [신규]:
     - 현재 블록 건너뛰기
     - 다음 블록으로 이동
     - 건너뛴 블록 표시
   - **➕ 블록 추가 버튼** [신규]:
     - 분석 중 블록 추가 가능
     - 추가 위치 선택 (현재 이후 / 마지막)
     - 블록 선택 모달
   - **🗑️ 블록 제거 버튼** [신규]:
     - 대기 중인 블록 제거
     - 이미 실행된 블록은 제거 불가
   - **⏹️ 분석 중지 버튼**:
     - 분석 완전 중지
     - 현재까지 결과 저장
     - 세션 유지

   **분석 결과 실시간 표시**:
   - 각 블록 완료 시 즉시 결과 표시
   - 단계별 요약 표시
   - CoT 사고 과정 표시

#### 5. **결과 조회 (개선)**
   - **탭 형식 결과 표시**:
     - 각 블록별 결과 탭
     - 전체 결과 종합 탭
   - **블록별 상세 결과**:
     - 분석 텍스트
     - CoT 단계별 사고 과정
     - 인용 및 출처
     - 신뢰도 점수 (선택 사항)
   - **피드백 기반 재검토 (개선)** [신규]:
     - 각 블록 결과 하단에 피드백 입력란
     - **💬 피드백 입력 버튼**: 입력란 표시/숨김
     - 피드백 작성 (text_area)
     - **🔄 재분석 요청 버튼**: 피드백 반영하여 재실행
     - 재분석 결과 비교 표시 (이전 vs 새로운 결과)
     - **✅ 결과 확정 버튼**: 최종 결과 선택
   - **결과 관리**:
     - 💾 개별 블록 결과 저장
     - 📋 결과 복사
     - 🔗 결과 공유 링크 생성

#### 6. **결과 다운로드 (개선)**
   - **Word 문서 생성**:
     - 프로젝트 정보 포함
     - 각 블록 결과 섹션별 구성
     - 차트 및 표 포함
     - **⬇️ Word 다운로드 버튼**
   - **Excel 데이터 시트** [신규]:
     - 블록별 결과를 시트로 구성
     - 구조화된 데이터 정리
     - **⬇️ Excel 다운로드 버튼**
   - **PDF 보고서** [신규]:
     - 고품질 PDF 생성
     - 템플릿 선택 가능
     - **⬇️ PDF 다운로드 버튼**
   - **JSON 데이터** [신규]:
     - 전체 분석 결과 JSON
     - API 연동 가능
     - **⬇️ JSON 다운로드 버튼**

#### 7. **세션 관리 (개선)**
   - **💾 분석 세션 저장**:
     - 세션 이름 입력
     - 전체 상태 저장
     - 저장 위치 선택 (로컬 / 서버)
   - **📂 저장된 세션 불러오기**:
     - 세션 목록 표시
     - 세션 정보 미리보기
     - **불러오기 버튼**
   - **🔄 분석 세션 초기화**:
     - 확인 다이얼로그
     - 모든 입력값 및 결과 리셋
   - **[DEBUG] 세션 상태 확인**: 개발자 모드

#### 8. **데이터 영속성 보장 (신규)**
   - **자동 저장**:
     - 5분마다 자동 저장
     - 페이지 이동 시 자동 저장
     - 저장 상태 표시 (마지막 저장 시간)
   - **복구 기능**:
     - 비정상 종료 시 복구
     - "이전 세션 복구" 버튼
     - 복구 가능한 세션 목록

---

## 4️⃣ Prompt Generator (이미지 프롬프트 생성기)

**목적**: 건축 프로젝트 분석 결과를 기반으로 AI 이미지 생성 프롬프트 생성

### 페이지 레이아웃

```
[사이드바]                     [메인 컨텐츠]
- 데이터 소스 선택              - 데이터 미리보기
- 이미지 설정                  - 프롬프트 생성 결과
- 플랫폼 선택 [신규]            - 건축 스타일 옵션 [신규]
```

### 핵심 기능

#### 1. **데이터 소스 선택 (기존 유지)**
   - 라디오 버튼:
     - PDF 파일 업로드
     - Document Analysis 결과 활용
     - 직접 입력
   - **✅ 데이터 소스 확인 버튼**

#### 2. **PDF 파일 업로드 (개선)**
   - PDF 파일 업로드
   - **✅ PDF 분석 버튼**: 텍스트 추출
   - 분석 완료 메시지
   - PDF 내용 미리보기

#### 3. **Document Analysis 결과 활용 (기존 유지)**
   - session_state에서 자동 로드
   - 프로젝트 정보 표시
   - CoT 히스토리 표시

#### 4. **직접 입력 (개선)**
   - 프로젝트명, 건물 유형, 위치, 건축주, 면적
   - **✅ 정보 확인 버튼**

#### 5. **이미지 플랫폼 선택 (신규) - 핵심 기능**
   - **플랫폼 선택 (라디오 버튼)**:
     - 🎨 Midjourney
     - 🍌 나노바나나
     - 🎬 기타 (Stable Diffusion, DALL-E 등)
   - 플랫폼별 최적화된 프롬프트 생성

#### 6. **이미지 설정 (확대)**
   - **이미지 유형** (selectbox):
     - 외관 렌더링
     - 내부 공간
     - 마스터플랜
     - 조감도
     - 상세도
     - 컨셉 이미지
     - 다이어그램 [신규]
   - **스타일 선호도** (multiselect):
     - 현대적, 미니멀, 자연친화적
     - 고급스러운, 기능적, 예술적, 상업적
   - **건축 스타일 (신규) - 핵심 기능**:
     - **건축가 스타일** (selectbox):
       - Le Corbusier (르 코르뷔지에)
       - Frank Lloyd Wright (프랭크 로이드 라이트)
       - Zaha Hadid (자하 하디드)
       - Tadao Ando (안도 타다오)
       - Norman Foster (노먼 포스터)
       - Renzo Piano (렌조 피아노)
       - Herzog & de Meuron (헤르조그 & 드 뫼롱)
       - MVRDV
       - Bjarke Ingels (비야케 잉겔스)
       - 기타 / 직접 입력
     - **설계 회사 스타일** (selectbox):
       - Gensler
       - HOK
       - Perkins&Will
       - SOM (Skidmore, Owings & Merrill)
       - Foster + Partners
       - OMA (Office for Metropolitan Architecture)
       - 현대건축
       - 삼우종합건축
       - 정림건축
       - 기타 / 직접 입력
   - **추가 설명** (text_area)
   - **✅ 설정 확인 버튼**

#### 7. **프롬프트 생성 (개선)**
   - **🎨 Midjourney 프롬프트 생성 버튼** (플랫폼에 따라 레이블 변경)
   - 입력 데이터 검증
   - AI 프롬프트 생성:
     - 프로젝트 정보 + 분석 결과 + 이미지 설정 통합
     - 건축가 스타일 키워드 자동 적용
     - 설계 회사 특징 반영
     - 플랫폼별 최적화된 프롬프트 구조
   - 로딩 표시

#### 8. **생성 결과 표시 (개선)**
   - **한글 설명**:
     - 건축적 특징, 분위기, 핵심 요소
   - **영어 프롬프트**:
     - Midjourney: 기존 형식 유지
     - 나노바나나: 최적화된 형식
     - 기타: 범용 형식
   - **📋 프롬프트 복사 버튼**
   - **플랫폼별 팁 표시** [신규]:
     - Midjourney: 파라미터 사용법 (--ar, --v, --style 등)
     - 나노바나나: 최적 설정 안내
   - **전체 분석 결과** (Expander)
   - **생성 모델 정보** (caption)

#### 9. **프롬프트 라이브러리 (신규)**
   - **💾 프롬프트 저장**:
     - 프롬프트 이름 입력
     - 태그 추가
     - 저장 버튼
   - **📚 저장된 프롬프트 목록**:
     - 프롬프트 검색
     - 태그 필터링
     - 프롬프트 불러오기
     - 프롬프트 수정/삭제

#### 10. **배치 프롬프트 생성 (신규)**
   - 여러 스타일/건축가 조합 선택
   - 한 번에 다중 프롬프트 생성
   - 프롬프트 비교 테이블
   - **⬇️ 전체 프롬프트 다운로드 버튼** (Excel/JSON)

---

## 5️⃣ Video Storyboard Generator (영상 스토리보드 생성기) [신규 페이지]

**목적**: 건축 프로젝트 영상용 스토리보드 및 Narrative 생성

### 페이지 레이아웃

```
[사이드바]                     [메인 컨텐츠]
- 데이터 소스 선택              - 스토리보드 미리보기
- 영상 설정                    - Scene 편집
- Narrative 옵션               - 타임라인
```

### 핵심 기능

#### 1. **데이터 소스 선택**
   - Document Analysis 결과 활용
   - 직접 입력 (프로젝트 정보)
   - **✅ 데이터 확인 버튼**

#### 2. **영상 설정**
   - **영상 유형** (selectbox):
     - 프로젝트 소개 영상
     - 공간 워크스루
     - 컨셉 설명 영상
     - 타임랩스 영상
     - 드론 촬영 영상
   - **영상 길이**: 30초 / 1분 / 2분 / 3분 / 5분
   - **타겟 관객**: 일반인 / 전문가 / 클라이언트 / 학생
   - **분위기**: 역동적 / 차분한 / 감성적 / 전문적

#### 3. **Scene 구성**
   - **Scene 개수 선택**: 3~20개
   - **✅ Scene 개수 확인 버튼**: Scene 입력 필드 생성
   - 각 Scene별 입력:
     - Scene 이름
     - 장면 설명 (text_area)
     - 촬영 각도 (selectbox): 정면 / 측면 / 조감 / 클로즈업 / 와이드
     - 카메라 움직임: 고정 / 팬 / 틸트 / 줌 / 트래킹
     - 예상 시간 (초)
   - **Scene 순서 조정**:
     - ⬆️ 위로, ⬇️ 아래로 버튼
   - **➕ Scene 추가**, **🗑️ Scene 삭제**

#### 4. **Narrative 생성**
   - **Narrative 타입** (selectbox):
     - 스토리텔링형
     - 설명형
     - 감성형
     - 기술 중심형
   - **Narrative 톤**: 공식적 / 친근한 / 열정적 / 차분한
   - **🎬 Narrative 생성 버튼**:
     - AI가 각 Scene에 맞는 Narrative 자동 생성
     - 전체 흐름 고려
   - Narrative 결과 표시 (각 Scene별)
   - **✏️ Narrative 수정**: 인라인 편집 가능

#### 5. **스토리보드 미리보기**
   - **타임라인 뷰**:
     - Scene 순서대로 표시
     - 각 Scene 썸네일 (텍스트)
     - Scene 시간 표시
     - 누적 시간 표시
   - **테이블 뷰**:
     - Scene 번호, 이름, 설명
     - 촬영 각도, 카메라 움직임
     - Narrative
     - 시간
   - **플레이 시뮬레이션** [고급 기능]:
     - ▶️ 재생 버튼
     - Scene 자동 전환
     - Narrative 읽기

#### 6. **프롬프트 생성**
   - **각 Scene별 이미지 프롬프트 자동 생성**:
     - Scene 설명 + 촬영 각도 → Midjourney 프롬프트
     - 생성된 프롬프트 표시
   - **📋 전체 프롬프트 복사**
   - **⬇️ 프롬프트 다운로드** (텍스트 파일)

#### 7. **스토리보드 다운로드**
   - **⬇️ Word 문서 다운로드**:
     - 표 형식 스토리보드
     - Scene별 이미지 삽입 공간
     - Narrative 포함
   - **⬇️ PDF 다운로드**:
     - 전문가용 스토리보드
     - 타임라인 포함
   - **⬇️ Excel 다운로드**:
     - Scene 데이터 시트
     - 편집 가능

#### 8. **템플릿 라이브러리**
   - 미리 정의된 스토리보드 템플릿:
     - 주거 프로젝트 템플릿
     - 상업 프로젝트 템플릿
     - 문화시설 템플릿
     - 교육시설 템플릿
   - 템플릿 선택 후 커스터마이징

---

## 🔗 페이지 간 데이터 연동 (개선)

### Session State 구조 (확대)

```python
# 사용자 정보
st.session_state.user_id = "USER001"
st.session_state.session_id = "SESSION_20250120_001"
st.session_state.team_id = "TEAM_01"

# 프로젝트 기본 정보
st.session_state.project_name
st.session_state.location
st.session_state.latitude
st.session_state.longitude
st.session_state.project_goals
st.session_state.additional_info

# 파일 및 텍스트
st.session_state.uploaded_files = []
st.session_state.pdf_text
st.session_state.reference_documents

# AI 분석 관련
st.session_state.llm_provider
st.session_state.llm_temperature
st.session_state.llm_max_tokens
st.session_state.selected_blocks = []
st.session_state.analysis_results = {}

# Chain of Thought
st.session_state.cot_session
st.session_state.cot_results = {}
st.session_state.cot_history = []
st.session_state.cot_status = "idle"  # idle / running / paused / completed

# Mapping 데이터 [신규]
st.session_state.mapping_data = {
    "site_location": {"lat": 0, "lon": 0, "radius": 1000},
    "osm_poi": [],
    "vworld_zoning": [],
    "kosis_stats": {},
    "cadastral_info": {}
}
st.session_state.collected_data_timestamp

# Block Generator [신규]
st.session_state.user_blocks = []
st.session_state.team_blocks = []
st.session_state.favorite_blocks = []

# Prompt Generator [신규]
st.session_state.generated_prompts = []
st.session_state.prompt_library = []

# Video Storyboard [신규]
st.session_state.storyboard_scenes = []
st.session_state.narratives = []

# 세션 관리
st.session_state.last_saved_time
st.session_state.auto_save_enabled = True
st.session_state.session_dirty = False  # 변경사항 있음
```

### 데이터 흐름 다이어그램

```
Block Generator
    → 새 블록 생성
    → st.session_state.user_blocks 저장
    ↓
Document Analysis
    ← user_blocks 로드
    ← Mapping 데이터 로드 (mapping_data)
    → 분석 실행
    → cot_results, analysis_results 저장
    ↓
Prompt Generator
    ← analysis_results, cot_history 로드
    → 프롬프트 생성
    → generated_prompts 저장
    ↓
Video Storyboard Generator [신규]
    ← analysis_results, generated_prompts 로드
    → 스토리보드 생성
    → storyboard_scenes, narratives 저장

Mapping
    → 데이터 수집
    → mapping_data 저장
    → Document Analysis로 전달
```

### 자동 저장 메커니즘 (신규)

```python
# 5분마다 자동 저장
if time.time() - st.session_state.last_saved_time > 300:
    save_session_to_server()
    st.session_state.last_saved_time = time.time()

# 페이지 이동 시 자동 저장
@st.cache_data
def on_page_change():
    if st.session_state.session_dirty:
        save_session_to_server()
        st.session_state.session_dirty = False

# 변경사항 추적
def mark_dirty():
    st.session_state.session_dirty = True
```

---

## 📊 동시 접속 지원 (25명)

### 시스템 요구사항

**하드웨어**:
- CPU: 8 Core 이상
- RAM: 16GB 이상
- 저장공간: 100GB 이상

**소프트웨어**:
- Streamlit 1.39.0+
- Redis (세션 관리)
- PostgreSQL (데이터 저장)

### 세션 격리 전략

1. **개인 세션 ID 자동 생성**:
   - 각 사용자에게 고유 ID 부여
   - 세션 ID 형식: `USER{번호}_{날짜}_{순번}`

2. **데이터 격리**:
   - 각 세션의 데이터를 별도 네임스페이스에 저장
   - Redis 키 형식: `session:{session_id}:{key}`

3. **리소스 제한**:
   - 사용자당 최대 메모리: 512MB
   - 동시 AI 요청: 최대 3개 (대기열 관리)
   - 세션 타임아웃: 4시간

4. **성능 최적화**:
   - 페이지네이션 (최대 500행)
   - 이미지/지도 레이지 로딩
   - 결과 캐싱
   - 백그라운드 작업 큐

### 모니터링

- 실시간 접속자 수 표시
- 서버 리소스 사용률
- 에러 로그
- 세션 활동 로그

---

## 🎯 주요 개선사항 요약

### 1. 공통 개선
✅ 모든 기능에 확인 버튼 추가
✅ 페이지 순서 재구성 (실제 작업 흐름)
✅ 페이지 간 데이터 영속성 강화 (자동 저장)
✅ 25명 동시 접속 지원

### 2. Block Generator
✅ 블록 상세 보기, 수정, 삭제 기능
✅ 개인 번호 부여 및 별도 관리
✅ 카테고리별 템플릿 블록 제공
✅ 블록 검색 및 필터링

### 3. Mapping (Site Data Collection 통합)
✅ 데이터 수집 탭 추가
✅ 좌표 기준 반경 데이터 수집
✅ 시각화 및 다운로드
✅ 분석 블록 직접 연동 (2가지 대안)

### 4. Document Analysis
✅ 분석 중 블록 추가/제거/건너뛰기
✅ 피드백 기반 재검토 개선
✅ Mapping 데이터 불러오기
✅ 다중 포맷 다운로드 (Word/Excel/PDF/JSON)

### 5. Prompt Generator
✅ 미드저니, 나노바나나 지원
✅ 건축가 스타일 옵션
✅ 설계 회사 스타일 옵션
✅ 프롬프트 라이브러리

### 6. Video Storyboard Generator [신규]
✅ Scene 구성 및 편집
✅ Narrative 자동 생성
✅ 타임라인 뷰
✅ 스토리보드 다운로드

---

## 📐 사이트 기능 구조도 (다이어그램)

```
┌─────────────────────────────────────────────────────────────┐
│                      🏠 메인 페이지                          │
│                   (API 키 관리, 세션 시작)                    │
└────────────┬────────────────────────────────────────────────┘
             │
    ┌────────┴────────┬─────────────┬─────────────┬──────────┐
    │                 │             │             │          │
    ▼                 ▼             ▼             ▼          ▼
┌────────┐      ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────┐
│ Block  │      │ Mapping  │  │ Document │  │ Prompt   │  │ Video  │
│Generator│────▶│          │─▶│ Analysis │─▶│Generator │─▶│Storyboard│
└────────┘      └──────────┘  └──────────┘  └──────────┘  └────────┘
    │                │              │             │             │
    │ ①블록 생성     │ ②데이터 수집  │ ③문서 분석   │ ④프롬프트   │ ⑤스토리보드
    │                │              │             │             │
    ▼                ▼              ▼             ▼             ▼
┌──────────────────────────────────────────────────────────────┐
│                    Session State (데이터 저장소)              │
│  - user_blocks    - mapping_data   - analysis_results        │
│  - generated_prompts  - storyboard_scenes                    │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  자동 저장 (5분)  │
                    │  Redis / Server   │
                    └──────────────────┘
```

---

## 📝 블록 DSL 구조 설명

### 블록이란?

블록(Block)은 **특정 분석 작업을 정의하는 구조화된 프롬프트**입니다. RISEN 구조를 따르며, AI에게 명확한 지시를 전달합니다.

### 블록 저장 구조 (blocks.json)

```json
{
  "blocks": [
    {
      "id": "user001_location_001",
      "name": "후보지 평가",
      "description": "입지 후보지의 장단점을 평가하고 점수를 산정",
      "category": "입지 분석",
      "owner": "USER001",
      "visibility": "private",
      "created_at": "2025-01-20T10:00:00",
      "role": "당신은 도시 계획 및 입지 분석 전문가입니다...",
      "instructions": "제공된 후보지 데이터를 분석하여 다음을 수행하세요...",
      "steps": [
        "후보지 정보 스캔 및 핵심 데이터 식별",
        "접근성, 인프라, 환경 등 평가 항목별 분석",
        "SWOT 분석 수행",
        "정량적 점수 산정 (100점 만점)",
        "종합 평가 및 추천 의견 작성"
      ],
      "end_goal": "후보지별 정량적 점수와 정성적 평가를 제공하여 최적 입지 선정을 지원",
      "narrowing": {
        "output_format": "표 형식 + 텍스트 설명",
        "suggested_items": ["접근성 점수", "인프라 점수", "환경 점수", "총점", "추천 여부"],
        "constraints": "객관적 데이터 기반 평가, 주관적 의견 최소화",
        "quality_standards": "정량적 점수는 명확한 근거 제시"
      }
    }
  ]
}
```

### 분석 과정 (블록이 어떻게 사용되는지)

```
1. 블록 로드
   blocks.json → 블록 정보 읽기

2. DSPy Signature 자동 생성
   블록 정보 → Python 클래스 생성

   class 후보지평가Signature(dspy.Signature):
       """후보지 평가 Signature"""
       input = dspy.InputField(desc="후보지 데이터")
       output = dspy.OutputField(desc="평가 결과")

3. AI 모델에 프롬프트 전달
   role + instructions + steps → AI 입력

4. Chain-of-Thought 실행
   AI가 단계별로 사고 과정 기록:
   - Step 1: "후보지 A는 지하철역까지 500m..."
   - Step 2: "접근성 점수 90점 산정..."
   - ...

5. 결과 구조화
   AI 출력 → 정해진 형식(narrowing)으로 변환

6. 결과 저장
   st.session_state.analysis_results[block_id] = 결과
```

### 예시 블록 3개

#### 예시 1: 기본 정보 추출 블록

```json
{
  "id": "basic_info_extraction",
  "name": "기본 정보 추출",
  "category": "기본 정보 & 요구사항",
  "role": "건축 프로젝트 분석 전문가",
  "instructions": "제공된 문서에서 프로젝트의 기본 정보를 추출하세요",
  "steps": [
    "문서 전체 스캔",
    "프로젝트명, 위치, 건축주, 용도 식별",
    "주요 요구사항 추출",
    "구조화된 정보로 정리"
  ],
  "end_goal": "프로젝트의 핵심 정보를 체계적으로 추출",
  "narrowing": {
    "output_format": "표 형식",
    "suggested_items": ["프로젝트명", "위치", "건축주", "용도", "규모"]
  }
}
```

#### 예시 2: 입지 분석 블록 (위 예시와 동일)

#### 예시 3: 비즈니스 모델 블록 [신규]

```json
{
  "id": "business_model_canvas",
  "name": "비즈니스 모델 분석",
  "category": "비즈니스 모델",
  "role": "비즈니스 전략 및 수익 모델 분석가",
  "instructions": "프로젝트의 비즈니스 모델을 분석하고 비즈니스 모델 캔버스를 작성하세요",
  "steps": [
    "고객 세그먼트 식별",
    "가치 제안 정의",
    "채널 및 고객 관계 분석",
    "수익원 및 비용 구조 파악",
    "핵심 자원 및 파트너 식별",
    "비즈니스 모델 캔버스 작성"
  ],
  "end_goal": "프로젝트의 비즈니스 모델을 체계적으로 분석하여 수익성 및 지속가능성 평가",
  "narrowing": {
    "output_format": "비즈니스 모델 캔버스 9개 블록",
    "suggested_items": [
      "고객 세그먼트", "가치 제안", "채널", "고객 관계",
      "수익원", "핵심 자원", "핵심 활동", "핵심 파트너", "비용 구조"
    ],
    "constraints": "각 블록마다 구체적인 내용 작성, 상호 연관성 고려"
  }
}
```

---

**문서 버전**: v2.0 (수정 반영)
**최종 수정**: 2025-01-20
