"""
ì‚¬ìš©ì ì •ì˜ ë¶„ì„ ë¸”ë¡ ê´€ë¦¬ ë„êµ¬
"""

def manage_custom_blocks(app):
    """ì‚¬ìš©ì ì •ì˜ ë¸”ë¡ ê´€ë¦¬"""
    print("ğŸ”§ ì‚¬ìš©ì ì •ì˜ ë¶„ì„ ë¸”ë¡ ê´€ë¦¬")
    print("=" * 50)
    
    while True:
        print("\nğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ì‘ì—…:")
        print("1. ë¸”ë¡ ì¶”ê°€")
        print("2. ë¸”ë¡ ì œê±°")
        print("3. ë¸”ë¡ ëª©ë¡ ë³´ê¸°")
        print("4. ë¸”ë¡ ì €ì¥")
        print("5. ë¸”ë¡ ë¶ˆëŸ¬ì˜¤ê¸°")
        print("6. ì¢…ë£Œ")
        
        choice = input("\nì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš” (1-6): ").strip()
        
        if choice == "1":
            add_custom_block(app)
        elif choice == "2":
            remove_custom_block(app)
        elif choice == "3":
            list_custom_blocks(app)
        elif choice == "4":
            save_custom_blocks(app)
        elif choice == "5":
            load_custom_blocks(app)
        elif choice == "6":
            print("ğŸ‘‹ ë¸”ë¡ ê´€ë¦¬ ì¢…ë£Œ")
            break
        else:
            print("âŒ ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.")

def add_custom_block(app):
    """ì‚¬ìš©ì ì •ì˜ ë¸”ë¡ ì¶”ê°€"""
    print("\nâ• ìƒˆë¡œìš´ ë¶„ì„ ë¸”ë¡ ì¶”ê°€")
    print("-" * 30)
    
    # ë¸”ë¡ ID ì…ë ¥
    block_id = input("ë¸”ë¡ ID (ì˜ë¬¸, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´ë§Œ): ").strip()
    if not block_id or not block_id.replace('_', '').isalnum():
        print("âŒ ì˜¬ë°”ë¥¸ ë¸”ë¡ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        return
    
    # ê¸°ì¡´ ë¸”ë¡ í™•ì¸
    if block_id in app.analysis_blocks.get_all_blocks():
        print(f"âŒ '{block_id}' IDëŠ” ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.")
        return
    
    # ë¸”ë¡ ì´ë¦„ ì…ë ¥
    name = input("ë¸”ë¡ ì´ë¦„ (ì˜ˆ: ğŸ¢ ê±´ë¬¼ êµ¬ì¡° ë¶„ì„): ").strip()
    if not name:
        print("âŒ ë¸”ë¡ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        return
    
    # ë¸”ë¡ ì„¤ëª… ì…ë ¥
    description = input("ë¸”ë¡ ì„¤ëª…: ").strip()
    if not description:
        description = f"{name} ë¶„ì„ ë¸”ë¡"
    
    # í”„ë¡¬í”„íŠ¸ ì…ë ¥
    print("\nğŸ“ ë¶„ì„ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:")
    print("(PDF ë‚´ìš©ì€ {pdf_content}ë¡œ í‘œì‹œë©ë‹ˆë‹¤)")
    print("ì˜ˆì‹œ: ë‹¤ìŒ ê±´ì¶• í”„ë¡œì íŠ¸ PDFë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”:\n\n{pdf_content}")
    
    prompt = input("\ní”„ë¡¬í”„íŠ¸: ").strip()
    if not prompt:
        print("âŒ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        return
    
    # ë¸”ë¡ ì¶”ê°€
    app.analysis_blocks.add_custom_block(block_id, name, description, prompt)
    
    print(f"\nâœ… ë¸”ë¡ '{name}' ì¶”ê°€ ì™„ë£Œ!")
    print("ğŸ’¡ ì´ì œ PDF ë¶„ì„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

def remove_custom_block(app):
    """ì‚¬ìš©ì ì •ì˜ ë¸”ë¡ ì œê±°"""
    print("\nâ– ì‚¬ìš©ì ì •ì˜ ë¸”ë¡ ì œê±°")
    print("-" * 30)
    
    # ì‚¬ìš©ì ì •ì˜ ë¸”ë¡ ëª©ë¡ í‘œì‹œ
    if not app.analysis_blocks.custom_blocks:
        print("ğŸ“ ì œê±°í•  ì‚¬ìš©ì ì •ì˜ ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
        return
    
    print("ğŸ“ ì‚¬ìš©ì ì •ì˜ ë¸”ë¡ ëª©ë¡:")
    for i, (block_id, block) in enumerate(app.analysis_blocks.custom_blocks.items(), 1):
        print(f"{i}. {block_id}: {block['name']}")
    
    # ì œê±°í•  ë¸”ë¡ ì„ íƒ
    try:
        choice = int(input("\nì œê±°í•  ë¸”ë¡ ë²ˆí˜¸: ")) - 1
        block_ids = list(app.analysis_blocks.custom_blocks.keys())
        
        if 0 <= choice < len(block_ids):
            block_id = block_ids[choice]
            block_name = app.analysis_blocks.custom_blocks[block_id]["name"]
            
            confirm = input(f"'{block_name}' ë¸”ë¡ì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): ").strip().lower()
            if confirm == 'y':
                app.analysis_blocks.remove_custom_block(block_id)
            else:
                print("âŒ ì œê±°ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
        else:
            print("âŒ ì˜ëª»ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.")
    except ValueError:
        print("âŒ ì˜¬ë°”ë¥¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")

def list_custom_blocks(app):
    """ì‚¬ìš©ì ì •ì˜ ë¸”ë¡ ëª©ë¡ í‘œì‹œ"""
    print("\nğŸ“‹ ì‚¬ìš©ì ì •ì˜ ë¸”ë¡ ëª©ë¡")
    print("-" * 30)
    
    if not app.analysis_blocks.custom_blocks:
        print("ğŸ“ ì‚¬ìš©ì ì •ì˜ ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
        return
    
    for block_id, block in app.analysis_blocks.custom_blocks.items():
        print(f"\nğŸ”§ {block['name']}")
        print(f"   ID: {block_id}")
        print(f"   ì„¤ëª…: {block['description']}")
        print(f"   í”„ë¡¬í”„íŠ¸: {block['prompt'][:100]}...")

def save_custom_blocks(app):
    """ì‚¬ìš©ì ì •ì˜ ë¸”ë¡ ì €ì¥"""
    print("\nğŸ’¾ ì‚¬ìš©ì ì •ì˜ ë¸”ë¡ ì €ì¥")
    print("-" * 30)
    
    if not app.analysis_blocks.custom_blocks:
        print("ğŸ“ ì €ì¥í•  ì‚¬ìš©ì ì •ì˜ ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
        return
    
    filename = input("ì €ì¥í•  íŒŒì¼ëª… (ê¸°ë³¸: custom_blocks.json): ").strip()
    if not filename:
        filename = "custom_blocks.json"
    
    if not filename.endswith('.json'):
        filename += '.json'
    
    app.analysis_blocks.save_custom_blocks(filename)

def load_custom_blocks(app):
    """ì‚¬ìš©ì ì •ì˜ ë¸”ë¡ ë¶ˆëŸ¬ì˜¤ê¸°"""
    print("\nğŸ“‚ ì‚¬ìš©ì ì •ì˜ ë¸”ë¡ ë¶ˆëŸ¬ì˜¤ê¸°")
    print("-" * 30)
    
    filename = input("ë¶ˆëŸ¬ì˜¬ íŒŒì¼ëª… (ê¸°ë³¸: custom_blocks.json): ").strip()
    if not filename:
        filename = "custom_blocks.json"
    
    if not filename.endswith('.json'):
        filename += '.json'
    
    app.analysis_blocks.load_custom_blocks(filename)

def show_block_templates():
    """ë¸”ë¡ í…œí”Œë¦¿ í‘œì‹œ"""
    print("\nğŸ“‹ ë¶„ì„ ë¸”ë¡ í…œí”Œë¦¿")
    print("=" * 50)
    
    templates = {
        "í™˜ê²½ë¶„ì„": {
            "name": "ğŸŒ± í™˜ê²½ ë¶„ì„",
            "description": "ê±´ì¶• í”„ë¡œì íŠ¸ì˜ í™˜ê²½ì  ìš”ì†Œë¥¼ ë¶„ì„í•©ë‹ˆë‹¤",
            "prompt": """ë‹¤ìŒ ê±´ì¶• í”„ë¡œì íŠ¸ PDFë¥¼ í™˜ê²½ì  ê´€ì ì—ì„œ ë¶„ì„í•´ì£¼ì„¸ìš”:

**ë¶„ì„ ìš”ì²­ì‚¬í•­:**
1. ìì—°í™˜ê²½ ìš”ì†Œ
   - ì¼ì¡°, ì±„ê´‘, í†µí’ ì¡°ê±´
   - ì£¼ë³€ ìì—°í™˜ê²½ê³¼ì˜ ì¡°í™”
   - ê¸°í›„ ì¡°ê±´ ê³ ë ¤ì‚¬í•­

2. ì—ë„ˆì§€ íš¨ìœ¨ì„±
   - ì—ë„ˆì§€ ì ˆì•½ ë°©ì•ˆ
   - ì¬ìƒì—ë„ˆì§€ í™œìš© ê°€ëŠ¥ì„±
   - ì¹œí™˜ê²½ ì„¤ë¹„ ê³„íš

3. í™˜ê²½ ì¹œí™”ì  ì„¤ê³„
   - ì¹œí™˜ê²½ ì¬ë£Œ ì‚¬ìš©
   - íê¸°ë¬¼ ìµœì†Œí™” ë°©ì•ˆ
   - ìƒíƒœê³„ ë³´ì „ ë°©ì•ˆ

**ë¶„ì„ í˜•ì‹:**
- ê° ìš”ì†Œë³„ êµ¬ì²´ì  ë¶„ì„
- ê°œì„  ë°©ì•ˆ ì œì‹œ
- í™˜ê²½ ì¹œí™”ì„± ì ìˆ˜ í‰ê°€ (1-10ì )

PDF ë‚´ìš©: {pdf_content}"""
        },
        "ì•ˆì „ì„±ë¶„ì„": {
            "name": "ğŸ›¡ï¸ ì•ˆì „ì„± ë¶„ì„",
            "description": "ê±´ì¶• í”„ë¡œì íŠ¸ì˜ ì•ˆì „ì„± ìš”ì†Œë¥¼ ë¶„ì„í•©ë‹ˆë‹¤",
            "prompt": """ë‹¤ìŒ ê±´ì¶• í”„ë¡œì íŠ¸ PDFë¥¼ ì•ˆì „ì„± ê´€ì ì—ì„œ ë¶„ì„í•´ì£¼ì„¸ìš”:

**ë¶„ì„ ìš”ì²­ì‚¬í•­:**
1. êµ¬ì¡°ì  ì•ˆì „ì„±
   - ë‚´ì§„ ì„¤ê³„ ìš”ì†Œ
   - í™”ì¬ ì•ˆì „ ì„¤ê³„
   - êµ¬ì¡°ë¬¼ ì•ˆì •ì„±

2. ì‚¬ìš©ì ì•ˆì „ì„±
   - ë¹„ìƒ ëŒ€í”¼ ê³„íš
   - ì•ˆì „ ì‹œì„¤ ë°°ì¹˜
   - ì ‘ê·¼ì„± ë° í¸ì˜ì„±

3. ìš´ì˜ ì•ˆì „ì„±
   - ìœ ì§€ë³´ìˆ˜ ê³„íš
   - ì•ˆì „ ê´€ë¦¬ ì²´ê³„
   - ìœ„í—˜ ìš”ì†Œ ê´€ë¦¬

**ë¶„ì„ í˜•ì‹:**
- ê° ì•ˆì „ ìš”ì†Œë³„ ë¶„ì„
- ìœ„í—˜ë„ í‰ê°€ (1-10ì )
- ê°œì„  ë°©ì•ˆ ì œì‹œ

PDF ë‚´ìš©: {pdf_content}"""
        },
        "ê²½ì œì„±ë¶„ì„": {
            "name": "ğŸ’° ê²½ì œì„± ë¶„ì„",
            "description": "ê±´ì¶• í”„ë¡œì íŠ¸ì˜ ê²½ì œì  íƒ€ë‹¹ì„±ì„ ë¶„ì„í•©ë‹ˆë‹¤",
            "prompt": """ë‹¤ìŒ ê±´ì¶• í”„ë¡œì íŠ¸ PDFë¥¼ ê²½ì œì  ê´€ì ì—ì„œ ë¶„ì„í•´ì£¼ì„¸ìš”:

**ë¶„ì„ ìš”ì²­ì‚¬í•­:**
1. ê±´ì„¤ë¹„ìš© ë¶„ì„
   - ì˜ˆìƒ ê±´ì„¤ë¹„ìš©
   - ë¹„ìš© êµ¬ì„± ìš”ì†Œ
   - ë¹„ìš© ì ˆê° ë°©ì•ˆ

2. ìš´ì˜ë¹„ìš© ë¶„ì„
   - ìœ ì§€ë³´ìˆ˜ ë¹„ìš©
   - ì—ë„ˆì§€ ë¹„ìš©
   - ê´€ë¦¬ë¹„ìš©

3. ìˆ˜ìµì„± ë¶„ì„
   - íˆ¬ì íšŒìˆ˜ ê¸°ê°„
   - ìˆ˜ìµë¥  ë¶„ì„
   - ê²½ì œì  íš¨ê³¼

**ë¶„ì„ í˜•ì‹:**
- ê° ë¹„ìš© ìš”ì†Œë³„ ë¶„ì„
- ê²½ì œì„± ì ìˆ˜ í‰ê°€ (1-10ì )
- ê°œì„  ë°©ì•ˆ ì œì‹œ

PDF ë‚´ìš©: {pdf_content}"""
        }
    }
    
    for template_id, template in templates.items():
        print(f"\nğŸ“‹ {template['name']}")
        print(f"   ì„¤ëª…: {template['description']}")
        print(f"   í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°: {template['prompt'][:100]}...")
    
    print(f"\nğŸ’¡ ì´ í…œí”Œë¦¿ë“¤ì„ ì°¸ê³ í•˜ì—¬ ìì‹ ë§Œì˜ ë¸”ë¡ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!")

def quick_add_template_block(app):
    """í…œí”Œë¦¿ ë¸”ë¡ ë¹ ë¥¸ ì¶”ê°€"""
    print("\nâš¡ í…œí”Œë¦¿ ë¸”ë¡ ë¹ ë¥¸ ì¶”ê°€")
    print("=" * 50)
    
    templates = {
        "1": ("í™˜ê²½ë¶„ì„", "ğŸŒ± í™˜ê²½ ë¶„ì„"),
        "2": ("ì•ˆì „ì„±ë¶„ì„", "ğŸ›¡ï¸ ì•ˆì „ì„± ë¶„ì„"),
        "3": ("ê²½ì œì„±ë¶„ì„", "ğŸ’° ê²½ì œì„± ë¶„ì„")
    }
    
    print("ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ í…œí”Œë¦¿:")
    for key, (template_id, name) in templates.items():
        print(f"{key}. {name}")
    
    choice = input("\nì¶”ê°€í•  í…œí”Œë¦¿ ë²ˆí˜¸: ").strip()
    
    if choice in templates:
        template_id, name = templates[choice]
        
        # í…œí”Œë¦¿ ë°ì´í„°
        template_data = {
            "í™˜ê²½ë¶„ì„": {
                "description": "ê±´ì¶• í”„ë¡œì íŠ¸ì˜ í™˜ê²½ì  ìš”ì†Œë¥¼ ë¶„ì„í•©ë‹ˆë‹¤",
                "prompt": """ë‹¤ìŒ ê±´ì¶• í”„ë¡œì íŠ¸ PDFë¥¼ í™˜ê²½ì  ê´€ì ì—ì„œ ë¶„ì„í•´ì£¼ì„¸ìš”:

**ë¶„ì„ ìš”ì²­ì‚¬í•­:**
1. ìì—°í™˜ê²½ ìš”ì†Œ
   - ì¼ì¡°, ì±„ê´‘, í†µí’ ì¡°ê±´
   - ì£¼ë³€ ìì—°í™˜ê²½ê³¼ì˜ ì¡°í™”
   - ê¸°í›„ ì¡°ê±´ ê³ ë ¤ì‚¬í•­

2. ì—ë„ˆì§€ íš¨ìœ¨ì„±
   - ì—ë„ˆì§€ ì ˆì•½ ë°©ì•ˆ
   - ì¬ìƒì—ë„ˆì§€ í™œìš© ê°€ëŠ¥ì„±
   - ì¹œí™˜ê²½ ì„¤ë¹„ ê³„íš

3. í™˜ê²½ ì¹œí™”ì  ì„¤ê³„
   - ì¹œí™˜ê²½ ì¬ë£Œ ì‚¬ìš©
   - íê¸°ë¬¼ ìµœì†Œí™” ë°©ì•ˆ
   - ìƒíƒœê³„ ë³´ì „ ë°©ì•ˆ

**ë¶„ì„ í˜•ì‹:**
- ê° ìš”ì†Œë³„ êµ¬ì²´ì  ë¶„ì„
- ê°œì„  ë°©ì•ˆ ì œì‹œ
- í™˜ê²½ ì¹œí™”ì„± ì ìˆ˜ í‰ê°€ (1-10ì )

PDF ë‚´ìš©: {pdf_content}"""
            },
            "ì•ˆì „ì„±ë¶„ì„": {
                "description": "ê±´ì¶• í”„ë¡œì íŠ¸ì˜ ì•ˆì „ì„± ìš”ì†Œë¥¼ ë¶„ì„í•©ë‹ˆë‹¤",
                "prompt": """ë‹¤ìŒ ê±´ì¶• í”„ë¡œì íŠ¸ PDFë¥¼ ì•ˆì „ì„± ê´€ì ì—ì„œ ë¶„ì„í•´ì£¼ì„¸ìš”:

**ë¶„ì„ ìš”ì²­ì‚¬í•­:**
1. êµ¬ì¡°ì  ì•ˆì „ì„±
   - ë‚´ì§„ ì„¤ê³„ ìš”ì†Œ
   - í™”ì¬ ì•ˆì „ ì„¤ê³„
   - êµ¬ì¡°ë¬¼ ì•ˆì •ì„±

2. ì‚¬ìš©ì ì•ˆì „ì„±
   - ë¹„ìƒ ëŒ€í”¼ ê³„íš
   - ì•ˆì „ ì‹œì„¤ ë°°ì¹˜
   - ì ‘ê·¼ì„± ë° í¸ì˜ì„±

3. ìš´ì˜ ì•ˆì „ì„±
   - ìœ ì§€ë³´ìˆ˜ ê³„íš
   - ì•ˆì „ ê´€ë¦¬ ì²´ê³„
   - ìœ„í—˜ ìš”ì†Œ ê´€ë¦¬

**ë¶„ì„ í˜•ì‹:**
- ê° ì•ˆì „ ìš”ì†Œë³„ ë¶„ì„
- ìœ„í—˜ë„ í‰ê°€ (1-10ì )
- ê°œì„  ë°©ì•ˆ ì œì‹œ

PDF ë‚´ìš©: {pdf_content}"""
            },
            "ê²½ì œì„±ë¶„ì„": {
                "description": "ê±´ì¶• í”„ë¡œì íŠ¸ì˜ ê²½ì œì  íƒ€ë‹¹ì„±ì„ ë¶„ì„í•©ë‹ˆë‹¤",
                "prompt": """ë‹¤ìŒ ê±´ì¶• í”„ë¡œì íŠ¸ PDFë¥¼ ê²½ì œì  ê´€ì ì—ì„œ ë¶„ì„í•´ì£¼ì„¸ìš”:

**ë¶„ì„ ìš”ì²­ì‚¬í•­:**
1. ê±´ì„¤ë¹„ìš© ë¶„ì„
   - ì˜ˆìƒ ê±´ì„¤ë¹„ìš©
   - ë¹„ìš© êµ¬ì„± ìš”ì†Œ
   - ë¹„ìš© ì ˆê° ë°©ì•ˆ

2. ìš´ì˜ë¹„ìš© ë¶„ì„
   - ìœ ì§€ë³´ìˆ˜ ë¹„ìš©
   - ì—ë„ˆì§€ ë¹„ìš©
   - ê´€ë¦¬ë¹„ìš©

3. ìˆ˜ìµì„± ë¶„ì„
   - íˆ¬ì íšŒìˆ˜ ê¸°ê°„
   - ìˆ˜ìµë¥  ë¶„ì„
   - ê²½ì œì  íš¨ê³¼

**ë¶„ì„ í˜•ì‹:**
- ê° ë¹„ìš© ìš”ì†Œë³„ ë¶„ì„
- ê²½ì œì„± ì ìˆ˜ í‰ê°€ (1-10ì )
- ê°œì„  ë°©ì•ˆ ì œì‹œ

PDF ë‚´ìš©: {pdf_content}"""
            }
        }
        
        data = template_data[template_id]
        app.analysis_blocks.add_custom_block(template_id, name, data["description"], data["prompt"])
        
        print(f"\nâœ… í…œí”Œë¦¿ ë¸”ë¡ '{name}' ì¶”ê°€ ì™„ë£Œ!")
    else:
        print("âŒ ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.")
